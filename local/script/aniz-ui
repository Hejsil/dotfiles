#!/bin/sh

fzf2() {
    ratio=3
    percent=$((100 / ratio))
    fzfimg.sh -m -d '\t' --tiebreak begin --with-nth=1,2,3,4,5 \
        --preview-window="right:${percent}%,border-none" \
        --preview 'draw_preview "$(aniz-ui get-image {6})"' \
        "$@"
}

images_dir='/tmp/aniz-ui'
mkdir -p "$images_dir"

command=$1
search=$2

while true; do
    picks=$(mktemp)
    case $command in
        database) aniz database | rg "$search" |
            fzf2 --disabled --bind 'change:reload:aniz database --search {q}' |
            cut -f5,6 >"$picks" ;;
        list) aniz list | rg "$search" |
            fzf2 --tabstop 4 --disabled --bind 'change:reload:aniz list --search {q}' |
            cut -f5,6 >"$picks" ;;
        copy)
            aniz database | rg "$search" |
                fzf2 --disabled --bind 'change:reload:aniz database --search {q}' |
                clipcopy
            exit 0
            ;;
        update)
            aniz list | cut -f6 | xargs -d'\n' aniz update
            exit 0
            ;;
        get-image)
            output="$images_dir/$(echo "$2" | xxhsum | cut -d' ' -f1)"
            cache -o "$output" -- aniz-ui download-image "$search" "$output"
            echo "$output"
            exit 0
            ;;
        download-image)
            output=$3
            aniz database "$search" | cut -f7 | xargs -d'\n' -I% curl -s -L % -o "$output"
            exit 0
            ;;
        *)
            wait
            rm "$picks"
            rm -r "$images_dir"
            exit 0
            ;;
    esac
    [ -s "$picks" ] || {
        rm "$picks"
        rm -r "$images_dir"
        exit 0
    }

    while true; do
        choice=$(printf '
watch-episode
complete
drop
plan-to-watch
put-on-hold
start-watching
update
remove
torrent
view
' | sed '/^$/d' | fzf | cut -f1)
        case $choice in
            view) cut -f2 "$picks" | xargs -d '\n' systemd-run --user "$BROWSER" ;;

            torrent)
                cut -f1 "$picks" | jq -sRr @uri |
                    sed 's#%0A#\n#g' |
                    sed 's#^#https://nyaa.si/?q=#' |
                    xargs -d '\n' systemd-run --user "$BROWSER"
                ;;
            complete | drop | plan-to-watch | put-on-hold | start-watching | update | remove | watch-episode)
                cut -f2 "$picks" | xargs -d'\n' aniz "$choice"
                ;;
            *) break ;;
        esac
    done

    rm "$picks"
done
